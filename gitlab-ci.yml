# GitLab CI/CD Configuration
# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø³ØªÙ…Ø± ÙˆØ§Ù„Ù†Ø´Ø± Ø§Ù„Ù…Ø³ØªÙ…Ø±

stages:
  - validate
  - test
  - build
  - deploy

variables:
  PROJECT_NAME: "text-diff-checker"

# ===== Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ =====
validate:html:
  stage: validate
  image: node:18-alpine
  script:
    - echo "ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© HTML..."
    - npm install -g html-validate
    - html-validate index.html || true
  only:
    - merge_requests
    - main
  allow_failure: true

validate:css:
  stage: validate
  image: node:18-alpine
  script:
    - echo "ğŸ¨ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© CSS..."
    - npm install -g stylelint stylelint-config-standard
    - echo '{"extends":"stylelint-config-standard"}' > .stylelintrc.json
    - stylelint "**/*.css" || true
  only:
    - merge_requests
    - main
  allow_failure: true

validate:js:
  stage: validate
  image: node:18-alpine
  script:
    - echo "ğŸ“œ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© JavaScript..."
    - npm install -g eslint
    - eslint index.html --ext .js || true
  only:
    - merge_requests
    - main
  allow_failure: true

# ===== Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± =====
test:accessibility:
  stage: test
  image: node:18-alpine
  script:
    - echo "â™¿ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„..."
    - npm install -g pa11y
    - pa11y index.html || true
  only:
    - merge_requests
    - main
  allow_failure: true

test:performance:
  stage: test
  image: node:18-alpine
  script:
    - echo "âš¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø¯Ø§Ø¡..."
    - npm install -g lighthouse
    - lighthouse index.html --output=json --output-path=./lighthouse-report.json || true
  artifacts:
    paths:
      - lighthouse-report.json
    expire_in: 1 week
  only:
    - main
  allow_failure: true

# ===== Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ =====
build:
  stage: build
  image: node:18-alpine
  script:
    - echo "ğŸ”¨ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹..."
    - mkdir -p public
    - cp index.html public/
    - cp README.md public/ || true
    - echo "âœ… ØªÙ… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!"
  artifacts:
    paths:
      - public
    expire_in: 1 week
  only:
    - main

# ===== Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø± =====
pages:
  stage: deploy
  script:
    - echo "ğŸš€ Ù†Ø´Ø± Ø¥Ù„Ù‰ GitLab Pages..."
  artifacts:
    paths:
      - public
  only:
    - main
  environment:
    name: production
    url: https://$CI_PROJECT_NAMESPACE.gitlab.io/$CI_PROJECT_NAME

# Ù†Ø´Ø± Ø¥Ù„Ù‰ Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ·ÙˆÙŠØ±
deploy:staging:
  stage: deploy
  script:
    - echo "ğŸ§ª Ù†Ø´Ø± Ø¥Ù„Ù‰ Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ·ÙˆÙŠØ±..."
  environment:
    name: staging
    url: https://$CI_PROJECT_NAMESPACE.gitlab.io/$CI_PROJECT_NAME/staging
  only:
    - develop
  when: manual

# ===== Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© =====
# ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
cleanup:
  stage: .post
  script:
    - echo "ğŸ§¹ ØªÙ†Ø¸ÙŠÙ..."
  when: always
